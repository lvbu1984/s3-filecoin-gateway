# S3–Filecoin Gateway  
## 行为规范（SPEC v0.2 · Draft）  
### —— Client-Side Encryption Constitution

> ⚠️ **状态：Draft（宪法草案）**  
> 本文档用于定义本项目的**不可妥协安全宪法**。  
> 任何实现、优化或扩展，如与本宪法冲突，一律视为无效实现。

---

## 0. 宪法声明（Constitutional Statement）

> **本系统是一个以“端到端加密（E2EE）”为第一原则的对象存储系统。**  
>  
> **如果无法在客户端完成加密，  
> 并保证系统任何组件均无法接触用户明文，  
> 本项目即不具备继续推进的合法性。**

---

## 1. 最高原则（Supreme Principle）

### 1.1 不可妥协条款（Non-Negotiable Rule）

> **在任何时间、任何路径、任何组件中，  
> Gateway / FWSS / MK20 / 存储节点  
> 均不得接触、处理、持久化或可逆推导用户明文数据。**

- 明文 **只允许** 存在于：
  - 用户控制的设备内存中
- 明文 **禁止** 出现在：
  - Gateway 进程
  - Gateway 磁盘
  - 网络日志
  - 调试输出
  - unsealed 数据副本
  - 任何后端服务

---

## 2. 加密责任边界（Encryption Responsibility Boundary）

### 2.1 加密位置（Encryption Placement）

> **加密必须发生在客户端（Client-Side Encryption）。**

- Gateway **不负责** 加密
- Gateway **不允许** 选择性开启/关闭加密
- Gateway **只接受密文字节流**

任何“服务端加密”“稍后加密”“可选加密”的设计，  
**均违反本宪法。**

---

### 2.2 加密后的系统视角

对 Gateway / Filecoin 而言：

- 对象 = **opaque byte stream**
- sealed = 密文
- unsealed = 密文
- 可读 ≠ 可理解

> **系统不应、也不需要理解用户内容。**

---

## 3. unsealed 数据的宪法定义

### 3.1 unsealed 的合法性

> **unsealed 数据是“密文的可读取形态”，  
> 而不是“明文”。**

- unsealed 允许存在
- 但其内容：
  - 必须是客户端加密后的密文
  - 对任何节点均不可理解

### 3.2 明确禁止事项

- ❌ 不允许 unsealed 明文存在
- ❌ 不允许“为了性能”解密
- ❌ 不允许“临时明文缓存”
- ❌ 不允许“调试时查看明文”

---

## 4. S3 语义在加密前提下的解释

### 4.1 对象语义

- S3 Object = **密文对象**
- Object size = 密文大小
- Object ETag = 密文 ETag

### 4.2 元数据原则

- Gateway **可以存储**：
  - 密文摘要
  - 客户端提供的明文摘要（opaque metadata）
- Gateway **不得解释或验证**明文摘要含义

---

## 5. Range / Multipart 的宪法约束

### 5.1 Range GET

> **Range GET 的作用对象是密文分块。**

- 解密责任完全在客户端
- Gateway 不参与任何解密逻辑

### 5.2 Multipart Upload

- 每个 part 必须已在客户端加密
- Gateway 只负责：
  - part 管理
  - 顺序组合
  - 状态推进

---

## 6. 密钥与身份原则（Key Sovereignty）

> **系统不持有任何可用于解密用户数据的密钥材料。**

- 不存储：
  - 明文密钥
  - 可逆加密参数
- 密钥管理属于：
  - 客户端
  - 用户身份（如钱包）

> **密钥即主权。  
> 无密钥，即无访问权。**

---

## 7. 合规性与实现约束（Compliance Rules）

### 7.1 合规实现定义

只有满足以下全部条件的实现，才被视为合法：

- 全链路密文
- 无明文路径
- 无明文日志
- 无明文缓存

### 7.2 非法实现示例（明确禁止）

- “先明文跑通，再补加密”
- “Debug 模式下可看明文”
- “性能模式下暂时解密”
- “可信节点可看明文”

---

## 8. 与 SPEC v0.1 的关系

- SPEC v0.1 定义 **行为**
- SPEC v0.2 定义 **边界**
- 当两者冲突时：
  > **v0.2 具有更高优先级**

---

## 9. 终极宪法条款（Final Clause）

> **本项目宁可牺牲性能、功能或进度，  
> 也不得牺牲端到端加密原则。**  
>  
> **任何违背该原则的实现，  
> 即使“可以跑通”，  
> 也被视为失败实现。**
